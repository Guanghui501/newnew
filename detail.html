<!DOCTYPE html>
  <html lang="zh-CN">
  <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Material Details - Nemesis</title>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.1/3Dmol-min.js"></script>
      <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f8f9fa;
            --text-color: #2c3e50;
            --border-radius: 8px;
            --box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 2rem;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .info-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
        }

        .viewer-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--box-shadow);
            height: 600px;
        }

        h2.material-title {
            color: var(--primary-color);
            font-size: 2rem;
            margin: 0 0 1.5rem;
            text-align: center;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 1rem;
        }

        .property-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .property-item {
            padding: 1rem;
            background: var(--light-bg);
            border-radius: var(--border-radius);
        }

        .property-item strong {
            display: block;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-color);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--accent-color);
            color: white;
        }

        #viewer {
            width: 100%;
            height: 100%;
            border-radius: var(--border-radius);
        }

        .incar-section {
            margin-top: 2rem;
        }

        details {
            background: var(--light-bg);
            border-radius: var(--border-radius);
            margin: 1rem 0;
        }

        summary {
            padding: 1rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--primary-color);
        }

        .incar-content {
            padding: 1rem;
            background: white;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .container {
                grid-template-columns: 1fr;
            }
            
            .viewer-card {
                height: 400px;
            }
        }
    </style>
  </head>
  <body>
      <div class="container">
        <div class="info-card">
            <h2 class="material-title" id="formula">加载中...</h2>
            
            <div class="property-grid">
                <div class="property-item">
                    <strong>空间群</strong>
                    <span id="space_group"></span>
                </div>
                <div class="property-item">
                    <strong>能量</strong>
                    <span id="energy"></span> eV
                </div>
                <div class="property-item">
                    <strong>密度</strong>
                    <span id="density"></span> g/cm³
                </div>
                <div class="property-item">
                    <strong>氮含量</strong>
                    <span id="n_concentration"></span>%
                </div>
                <div class="property-item">
                    <strong>爆轰能量</strong>
                    <span id="ed"></span> kJ/g
                </div>
                <div class="property-item">
                    <strong>爆速</strong>
                    <span id="vd"></span> km/s
                </div>
                <div class="property-item">
                    <strong>爆压</strong>
                    <span id="pd"></span> GPa
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" id="download-cif" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-right:8px;">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                    </svg>
                    下载CIF文件
                </button>
                <button class="btn btn-secondary" id="toggle-lattice" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-right:8px;">
                        <path d="M3 3h8v8H3zm10 0h8v8h-8zM3 13h8v8H3zm10 0h8v8h-8z"/>
                    </svg>
                    晶格显示
                </button>
            </div>

            <div class="incar-section">
                <details>
                    <summary>VASP计算参数 (INCAR)</summary>
                    <pre class="incar-content">
PREC   = Normal
ENCUT  = 520 eV
NELMIN= 5
LREAL = F    
KSPACING = 0.15
EDIFF  = 1E-5
SIGMA = 0.2
ISPIN = 1    
KPAR = 4
NPAR = 1     
# Ionic Relaxation
ICHARG = 2
EDIFFG = -0.01        
NSW    = 300          
IBRION = 2
POTIM = 0.5
ISIF   = 3            
PSTRESS= 0
LCHARG =  F
LWAVE  =  F</pre>
                </details>
                <button class="btn btn-primary" onclick="downloadINCAR()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="margin-right:8px;">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                    </svg>
                    下载INCAR
                </button>
            </div>
        </div>

        <div class="viewer-card">
            <div id="viewer"></div>
        </div>
    </div>
 
      <script>
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');
      let currentCIF = '';
      let viewer = null;
      let latticeVisible = false;
      let labelsVisible = false;
 
      // 数据获取与初始化
      fetch('db.json')
          .then(response => response.json())
          .then(data => {
              const material = data[id];
              if (!material) {
                  showErrorMessage("未找到材料数据");
                  return;
              }
 
              updateMaterialInfo(material);
              initializeViewer(material);
          })
          .catch(err => {
              console.error("数据获取失败:", err);
              showErrorMessage("数据加载失败");
          });
 
      function showErrorMessage(msg) {
          document.getElementById('formula').innerText = msg;
          document.getElementById('viewer-message').innerText = msg;
      }
        
     function italicizeLettersOnly(str) {
        return str.replace(/[A-Za-z]+/g, match => `<em>${match}</em>`);
    }
        
      function updateMaterialInfo(material) {
          document.getElementById('formula').innerHTML = formatFormula(material.formula);
          document.getElementById('space_group').innerHTML =
              material.space_group_symbol && material.space_group_number
                  ? `${italicizeLettersOnly(material.space_group_symbol)} (No. ${material.space_group_number})`
                  : 'N/A';
          document.getElementById('energy').innerText = material.energy?.toFixed(3) ?? 'N/A';
          document.getElementById('density').innerText = material.mass_density?.toFixed(3) ?? 'N/A';
          document.getElementById('n_concentration').innerText = material.N_concentration?.toFixed(3) ?? 'N/A';
          document.getElementById('ed').innerText = material.E_d?.toFixed(3) ?? 'N/A';
          document.getElementById('vd').innerText = material.V_d?.toFixed(3) ?? 'N/A';
          document.getElementById('pd').innerText = material.P_d?.toFixed(3) ?? 'N/A';
          document.getElementById('reaction').innerHTML = formatFormula(material.reaction?.replace(/->/g, '→') ?? 'N/A');
      }
 
      function initializeViewer(material) {
          try {
              currentCIF = generateCIF(material);
              viewer = $3Dmol.createViewer(document.getElementById("viewer"), { 
                  backgroundColor: "white",
                  defaultZoom: 1.0
              });
              viewer.addModel(currentCIF, "cif");
              renderAtomsAndBonds();
              viewer.zoomTo();
              viewer.center();
              enableControls();
              document.getElementById("viewer-message")?.remove();
          } catch (err) {
              console.error("3D结构渲染失败:", err);
              document.getElementById('viewer-message').innerText = "3D结构加载失败";
          }
      }
 
      function renderAtomsAndBonds() {
          if (!viewer) return;
 
          // 清除残留元素
          viewer.removeAllShapes();
          viewer.removeAllLabels();
 
          // 设置基础样式
          viewer.setStyle({}, { 
              stick: { radius: 0.15 }, 
              sphere: { 
                  scale: 0.3,
                  colorscheme: "Jmol"
              } 
          });
 
          // 原子标签显示
          if (labelsVisible) {
              const atoms = viewer.getModel().selectedAtoms({});
              atoms.forEach(atom => {
                  viewer.addLabel(atom.elem, {
                      position: atom,
                      fontSize: 0.8,
                      fontColor: 'blue',
                      backgroundColor: 0xeeeeee,
                      backgroundOpacity: 0.7,
                      inFront: true
                  });
              });
          }
 
          // 晶格显示
          if (latticeVisible) {
              viewer.addUnitCell({
                  box: { color: 0x0000ff, radius: 0.1 },
                  a: { color: 0xff0000, radius: 0.1 },
                  b: { color: 0x00ff00, radius: 0.1 },
                  c: { color: 0x0000ff, radius: 0.1 }
              });
          }
 
          viewer.render();
      }
 
      function enableControls() {
          document.getElementById('download-cif').disabled = false;
          document.getElementById('toggle-lattice').disabled = false;
          document.getElementById('toggle-labels').disabled = false;
      }
 
      // 事件监听
      document.getElementById('download-cif').addEventListener('click', () => {
          if (!currentCIF) return;
 
          const blob = new Blob([currentCIF], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `material_${id}.cif`;
          a.click();
          URL.revokeObjectURL(url);
      });
 
      document.getElementById('toggle-lattice').addEventListener('click', function() {
          latticeVisible = !latticeVisible;
          this.textContent = latticeVisible ? "Hide the lattice pattern" : "Display the lattice pattern";
          renderAtomsAndBonds();
      });
 
      document.getElementById('toggle-labels').addEventListener('click', function() {
          labelsVisible = !labelsVisible;
          this.textContent = labelsVisible ? "Hide atomic labels" : "Display atomic labels";
          renderAtomsAndBonds();
      });
 
      // INCAR下载功能
      function downloadINCAR() {
          const content = document.querySelector('.incar-content').textContent;
          const blob = new Blob([content], {type: 'text/plain'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `INCAR_${id}.txt`;
          a.click();
          URL.revokeObjectURL(url);
      }
 
      // 工具函数
      function generateCIF(data) {
          const { cell, symbols, positions } = data;
          let cif = "data_generated\n";
          cif += "_cell_length_a " + cell[0][0].toFixed(6) + "\n";
          cif += "_cell_length_b " + cell[1][1].toFixed(6) + "\n";
          cif += "_cell_length_c " + cell[2][2].toFixed(6) + "\n";
          cif += "_cell_angle_alpha 90\n";
          cif += "_cell_angle_beta 90\n";
          cif += "_cell_angle_gamma 90\n";
          cif += "loop_\n_atom_site_label\n_atom_site_fract_x\n_atom_site_fract_y\n_atom_site_fract_z\n";
 
          for (let i = 0; i < symbols.length; i++) {
              const [x, y, z] = positions[i];
              const fx = x / cell[0][0];
              const fy = y / cell[1][1];
              const fz = z / cell[2][2];
              cif += `${symbols[i]} ${fx.toFixed(6)} ${fy.toFixed(6)} ${fz.toFixed(6)}\n`;
          }
          return cif;
      }
 
      function formatFormula(formula) {
          return formula.replace(/([A-Za-z]+)(\d*)/g, (_, elem, num) => 
              num ? `${elem}<sub>${num}</sub>` : elem
          );
      }
      </script>
  </body>
  </html>
