<!DOCTYPE html>
  <html lang="zh-CN">
  <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Material Details - Nemesis</title>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/3Dmol/2.0.1/3Dmol-min.js"></script>
      <style>
      /* 更新颜色方案 */
      :root {
          --primary-blue: #2A5D84;
          --secondary-teal: #3AA6B9;
          --accent-orange: #FF6B35;
          --light-bg: #F8F9FA;
          --dark-text: #2C3E50;
      }
      
      body {
          background: var(--light-bg);
          color: var(--dark-text);
          line-height: 1.7;
      }
      
      /* 标题美化 */
      .info h2 {
          color: var(--primary-blue);
          font-size: 2.2rem;
          margin: 1.5rem 0;
          padding: 1rem 0;
          border-bottom: 3px solid var(--secondary-teal);
          position: relative;
          font-weight: 700;
      }
      
      .info h2::after {
          content: "";
          position: absolute;
          bottom: -3px;
          left: 0;
          width: 120px;
          height: 3px;
          background: var(--accent-orange);
      }
      
      /* 信息条目美化 */
      .info p {
          margin: 1.2rem 0;
          padding: 0.8rem 1.2rem;
          background: white;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          display: grid;
          grid-template-columns: 160px 1fr;
          align-items: center;
      }
      
      .info p strong {
          color: var(--primary-blue);
          font-weight: 600;
      }
      
      /* 3D查看器容器美化 */
      .viewer-container {
          border-radius: 12px;
          overflow: hidden;
          box-shadow: 0 8px 30px rgba(0,0,0,0.12);
          background: white;
          transition: transform 0.3s ease;
      }
      
      .viewer-container:hover {
          transform: translateY(-5px);
      }
      
      #viewer {
          border-radius: 12px 12px 0 0;
      }
      
      /* 按钮组美化 */
      .button-container {
          margin: 2rem 0;
      }
      
      .btn {
          min-width: 220px;
          padding: 12px 24px;
          border-radius: 8px;
          font-weight: 600;
          letter-spacing: 0.5px;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          display: flex;
          align-items: center;
          gap: 8px;
          justify-content: center;
      }
      
      .download-btn {
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      }
      
      .toggle-lattice-btn {
          background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      }
      
      .toggle-labels-btn {
          background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      }
      
      .btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      }
      
      /* INCAR参数区美化 */
      .incar-section {
          margin: 2.5rem 0;
          background: white;
          border-radius: 12px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }
      
      details {
          border-left: 4px solid var(--secondary-teal);
          background: linear-gradient(to right, #f8f9fa 50%, white 100%);
      }
      
      summary {
          font-size: 1.1rem;
          padding: 1.2rem;
          color: var(--primary-blue);
      }
      
      .incar-content {
          background: #fcfcfc;
          border: 1px solid #e0e0e0;
          border-radius: 8px;
          padding: 1.5rem;
          font-size: 0.95rem;
          line-height: 1.8;
          color: #4a5568;
          position: relative;
      }
      
      .incar-content::before {
          content: "INCAR";
          position: absolute;
          top: -12px;
          left: 20px;
          background: var(--primary-blue);
          color: white;
          padding: 4px 12px;
          border-radius: 4px;
          font-size: 0.85rem;
      }
      
      /* 加载提示美化 */
      #viewer-message {
          background: rgba(255,255,255,0.9);
          padding: 1rem 2rem;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          font-weight: 500;
          display: inline-flex;
          align-items: center;
          gap: 8px;
      }
      
      #viewer-message::before {
          content: "⏳";
          font-size: 1.2rem;
      }
      
      /* 响应式优化 */
      @media (max-width: 768px) {
          .info p {
              grid-template-columns: 1fr;
              gap: 0.5rem;
          }
          
          .btn {
              width: 100%;
          }
          
          #viewer {
              height: 400px;
          }
      }
      </style>
  </head>
  <body>
      <div class="container">
          <div class="info">
              <h2 id="formula">加载中...</h2>
              <p><strong>Space Group:</strong> <span id="space_group"></span></p>
              <p><strong>Energy:</strong> <span id="energy"></span> eV</p>
              <p><strong>Mass Density:</strong> <span id="density"></span> g/cm³</p>
              <p><strong>Nitrogen Concentration:</strong> <span id="n_concentration"></span>%</p>
              <p><strong>Energy Density (E<sub>d</sub>):</strong> <span id="ed"></span> kJ/g</p>
              <p><strong>Detonation Velocity (V<sub>d</sub>):</strong> <span id="vd"></span> km/s</p>
              <p><strong>Detonation Pressure (P<sub>d</sub>):</strong> <span id="pd"></span> GPa</p>
              <p><strong>Reaction:</strong> <span id="reaction"></span></p>
 
              <div class="button-container">
                  <button id="download-cif" class="btn download-btn" disabled>Download the CIF file</button>
                  <button id="toggle-lattice" class="btn toggle-lattice-btn" disabled>Display the lattice pattern</button>
                  <button id="toggle-labels" class="btn toggle-labels-btn" disabled>Display atomic labels</button>
              </div>
 
              <!-- 新增INCAR参数区域 -->
              <div class="incar-section">
                  <details>
                      <summary>VASP Calculation Parameters (INCAR)</summary>
                      <pre class="incar-content">
  PREC   = Normal
  ENCUT  = 520 eV
  NELMIN= 5
  LREAL = F    
  KSPACING = 0.15
  EDIFF  = 1E-5
  SIGMA = 0.2
  ISPIN = 1    
  KPAR = 4
  NPAR = 1     
  # Ionic Relaxation
  ICHARG = 2
  EDIFFG = -0.01        
  NSW    = 300          
  IBRION = 2
  POTIM = 0.5
  ISIF   = 3            
  PSTRESS= 0
  LCHARG =  F
  LWAVE  =  F</pre>
                  </details>
                  <button class="btn download-btn" onclick="downloadINCAR()" style="margin-top: 10px;">
                      Download INCAR
                  </button>
              </div>
          </div>
 
          <div class="viewer-container">
              <div id="viewer">
                  <div id="viewer-message">加载结构中...</div>
              </div>
          </div>
      </div>
 
      <script>
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get('id');
      let currentCIF = '';
      let viewer = null;
      let latticeVisible = false;
      let labelsVisible = false;
 
      // 数据获取与初始化
      fetch('db.json')
          .then(response => response.json())
          .then(data => {
              const material = data[id];
              if (!material) {
                  showErrorMessage("未找到材料数据");
                  return;
              }
 
              updateMaterialInfo(material);
              initializeViewer(material);
          })
          .catch(err => {
              console.error("数据获取失败:", err);
              showErrorMessage("数据加载失败");
          });
 
      function showErrorMessage(msg) {
          document.getElementById('formula').innerText = msg;
          document.getElementById('viewer-message').innerText = msg;
      }
        
     function italicizeLettersOnly(str) {
        return str.replace(/[A-Za-z]+/g, match => `<em>${match}</em>`);
    }
        
      function updateMaterialInfo(material) {
          document.getElementById('formula').innerHTML = formatFormula(material.formula);
          document.getElementById('space_group').innerHTML =
              material.space_group_symbol && material.space_group_number
                  ? `${italicizeLettersOnly(material.space_group_symbol)} (No. ${material.space_group_number})`
                  : 'N/A';
          document.getElementById('energy').innerText = material.energy?.toFixed(3) ?? 'N/A';
          document.getElementById('density').innerText = material.mass_density?.toFixed(3) ?? 'N/A';
          document.getElementById('n_concentration').innerText = material.N_concentration?.toFixed(3) ?? 'N/A';
          document.getElementById('ed').innerText = material.E_d?.toFixed(3) ?? 'N/A';
          document.getElementById('vd').innerText = material.V_d?.toFixed(3) ?? 'N/A';
          document.getElementById('pd').innerText = material.P_d?.toFixed(3) ?? 'N/A';
          document.getElementById('reaction').innerHTML = formatFormula(material.reaction?.replace(/->/g, '→') ?? 'N/A');
      }
 
      function initializeViewer(material) {
          try {
              currentCIF = generateCIF(material);
              viewer = $3Dmol.createViewer(document.getElementById("viewer"), { 
                  backgroundColor: "white",
                  defaultZoom: 1.0
              });
              viewer.addModel(currentCIF, "cif");
              renderAtomsAndBonds();
              viewer.zoomTo();
              viewer.center();
              enableControls();
              document.getElementById("viewer-message")?.remove();
          } catch (err) {
              console.error("3D结构渲染失败:", err);
              document.getElementById('viewer-message').innerText = "3D结构加载失败";
          }
      }
 
      function renderAtomsAndBonds() {
          if (!viewer) return;
 
          // 清除残留元素
          viewer.removeAllShapes();
          viewer.removeAllLabels();
 
          // 设置基础样式
          viewer.setStyle({}, { 
              stick: { radius: 0.15 }, 
              sphere: { 
                  scale: 0.3,
                  colorscheme: "Jmol"
              } 
          });
 
          // 原子标签显示
          if (labelsVisible) {
              const atoms = viewer.getModel().selectedAtoms({});
              atoms.forEach(atom => {
                  viewer.addLabel(atom.elem, {
                      position: atom,
                      fontSize: 0.8,
                      fontColor: 'blue',
                      backgroundColor: 0xeeeeee,
                      backgroundOpacity: 0.7,
                      inFront: true
                  });
              });
          }
 
          // 晶格显示
          if (latticeVisible) {
              viewer.addUnitCell({
                  box: { color: 0x0000ff, radius: 0.1 },
                  a: { color: 0xff0000, radius: 0.1 },
                  b: { color: 0x00ff00, radius: 0.1 },
                  c: { color: 0x0000ff, radius: 0.1 }
              });
          }
 
          viewer.render();
      }
 
      function enableControls() {
          document.getElementById('download-cif').disabled = false;
          document.getElementById('toggle-lattice').disabled = false;
          document.getElementById('toggle-labels').disabled = false;
      }
 
      // 事件监听
      document.getElementById('download-cif').addEventListener('click', () => {
          if (!currentCIF) return;
 
          const blob = new Blob([currentCIF], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `material_${id}.cif`;
          a.click();
          URL.revokeObjectURL(url);
      });
 
      document.getElementById('toggle-lattice').addEventListener('click', function() {
          latticeVisible = !latticeVisible;
          this.textContent = latticeVisible ? "Hide the lattice pattern" : "Display the lattice pattern";
          renderAtomsAndBonds();
      });
 
      document.getElementById('toggle-labels').addEventListener('click', function() {
          labelsVisible = !labelsVisible;
          this.textContent = labelsVisible ? "Hide atomic labels" : "Display atomic labels";
          renderAtomsAndBonds();
      });
 
      // INCAR下载功能
      function downloadINCAR() {
          const content = document.querySelector('.incar-content').textContent;
          const blob = new Blob([content], {type: 'text/plain'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `INCAR_${id}.txt`;
          a.click();
          URL.revokeObjectURL(url);
      }
 
      // 工具函数
      function generateCIF(data) {
          const { cell, symbols, positions } = data;
          let cif = "data_generated\n";
          cif += "_cell_length_a " + cell[0][0].toFixed(6) + "\n";
          cif += "_cell_length_b " + cell[1][1].toFixed(6) + "\n";
          cif += "_cell_length_c " + cell[2][2].toFixed(6) + "\n";
          cif += "_cell_angle_alpha 90\n";
          cif += "_cell_angle_beta 90\n";
          cif += "_cell_angle_gamma 90\n";
          cif += "loop_\n_atom_site_label\n_atom_site_fract_x\n_atom_site_fract_y\n_atom_site_fract_z\n";
 
          for (let i = 0; i < symbols.length; i++) {
              const [x, y, z] = positions[i];
              const fx = x / cell[0][0];
              const fy = y / cell[1][1];
              const fz = z / cell[2][2];
              cif += `${symbols[i]} ${fx.toFixed(6)} ${fy.toFixed(6)} ${fz.toFixed(6)}\n`;
          }
          return cif;
      }
 
      function formatFormula(formula) {
          return formula.replace(/([A-Za-z]+)(\d*)/g, (_, elem, num) => 
              num ? `${elem}<sub>${num}</sub>` : elem
          );
      }
      </script>
  </body>
  </html>
